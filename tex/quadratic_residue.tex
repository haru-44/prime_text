\subsubsection{定義}
整数の世界において平方数とは、整数の2乗の形で表される数である。
例えば、$4, 9, 16, 25$は平方数である。
同じように、剰余の世界でも平方数を考えることができる。
ただし、剰余の世界では「平方数」ではなく「平方剰余」と呼んでいる。

\begin{Defi}{\IND{平方剰余}{へいほうしようよ}(quadratic residue), \IND{平方非剰余}{へいほうひしようよ}(quadratic nonresidue)}{quadratic residue}
整数$a$と正整数$n$について、$x^2 \equiv a \pmod{n}$を満たす整数$x$が存在するとき、$a$を$n$を法とする平方剰余と呼ぶ。
逆に$x$が存在しないとき、$a$を$n$を法とする平方非剰余と呼ぶ。
\end{Defi}

これ以降は、素数$p$で考えていく。

\begin{Prop}{}{}
素数$p$において、$a$が$p$を法とする平方剰余ならば、$x^2\equiv a\pmod{p}$となるような$x$は、$\mathbb{Z}_p^*$上に必ずちょうど2つ存在する。
\end{Prop}

という事実から考察を進めていこう。
整数や実数の世界では当たり前のことだが、その理屈は$\mathbb{Z}_p^*$上でも同じで、$x$が$x^2\equiv a\pmod{p}$となるならば、$-x$も$a$の解であり、それ以外には存在しない。
そう言われても、狐につままれたような感じだろうから、例を見てみる。

$p=5$のとき
\begin{table}[h]
  \begin{tabular}{|c||c|c|c|c|}\hline
    $a$ & 1 & 2 & 3 & 4 \\\hline
    $a^2$ & 1 & 4 & 4 & 1 \\\hline
  \end{tabular}
\end{table}

となるから、(下段に現れる)1,4が平方剰余で、2,3が平方非剰余である。
もう少し大きい、$p=11$のときも試してみよう。
\begin{table}[h]
  \begin{tabular}{|c||c|c|c|c|c|c|c|c|c|c|}\hline
    $a$ & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\\hline
    $a^2$ & 1 & 4 & 9 & 5 & 3 & 3 & 5 & 9 & 4 & 1 \\\hline
  \end{tabular}
\end{table}

この場合も、1,3,4,5,9の5つが平方剰余で、残りの2,6,7,8が平方非剰余である。
このような表に書き出してみると分かるが、$p=11$の場合は、5と6を境界として鏡写しになったように$a^2$が配されている。
これは、解が$\pm a$であることを反映しているが、もう少し考察すると次の事実が明らかになる。
ここで、$\mathbf{QR}_p$は$\mathbb{Z}_p^*$上の平方剰余の集合、$\mathbf{QNR}_p$は$\mathbb{Z}_p^*$上の平方非剰余の集合とする。

\begin{Prop}{}{quadratic_residue_order}
\begin{align*}
\sharp\mathbf{QR}_p = \sharp\mathbf{QNR}_p = \frac{p-1}{2}
\end{align*}
\end{Prop}

つまり、平方剰余の元と平方非剰余の元は、$\mathbb{Z}_p^*$上にちょうど半分ずつ存在しているのだ。
これは既に例示した$p=5$と$p=11$の場合でも確認できて、それぞれ平方剰余の元は2個と5個あることが分かる。

平方剰余の簡単な確認になるが、次の事実も示してみよう。

\begin{Prop}{}{quadratic_residue_product}\;
\begin{enumerate}
 \item $a,b\in\mathbf{QR}_p$ならば$ab\in\mathbf{QR}_p$
 \item $a\in\mathbf{QR}_p, b\in\mathbf{QNR}_p$ならば$ab\in\mathbf{QNR}_p$
 \item $a,b\in\mathbf{QNR}_p$ならば$ab\in\mathbf{QR}_p$
\end{enumerate}
\end{Prop}

\begin{prProof}{quadratic_residue_product}\;
\begin{enumerate}
 \item $a,b\in\mathbf{QR}_p$であるから、$a\equiv s^2\pmod{p}, b\equiv t^2\pmod{p}$となる元$s,t\in\mathbb{Z}_p^*$が存在する。よって、$ab\equiv s^2t^2\equiv(st)^2\pmod{p}$も平方剰余である。
 \item $a\in\mathbf{QR}_p, b\in\mathbf{QNR}_p$のとき、$ab\in\mathbf{QR}_p$であると仮定すると、$a\equiv s^2\pmod{p}, ab\equiv t^2\pmod{p}$となる元$s,t\in\mathbb{Z}_p^*$が存在する。$a\equiv s^2\pmod{p}$を代入すると、$s^2b\equiv t^2\pmod{p}\iff b\equiv (t/s)^2\pmod{p}$を得るが、$b$が平方剰余となって矛盾。
 \item ある$c \in \mathbf{QNR}_p$について、$f(x)=cx$を考える。$\mathbb{Z}_p^*$が群であるから、$f:\mathbb{Z}_p^*\to\mathbb{Z}_p^*$は全単射である。$x \in \mathbb{Z}_p^*$のうち、$x\in\mathbf{QR}_p$は$cx\in\mathbf{QNR}_p$に移るので、残る$x\in\mathbf{QNR}_p$は(\rProp{quadratic_residue_order}の事実から)$cx\in\mathbf{QR}_p$に移るしかない。よって、題意は示された。
\end{enumerate}
\end{prProof}

次に、いちいち「$a$を$p$を法とする平方非剰余」等と言うのは面倒くさいので、今後はLegendre記号と呼ばれる記号で表すことにする。
しかし慣習とはいえ、分数にしか見えないこの記号は混乱を招く。
しかも、後で紹介するJacobi記号(\rDefi{Jacobi_symbol})も同じように書くものだから、混乱の度合いは増すのだが、そこに文句を言っても仕方がないので諦めよう。

\begin{Defi}{\IND{Legendre記号}{Legendreきこう}, Legendre symbol}{Legendre_symbol}
Legendre記号$\left(\frac{a}{p}\right)$は、整数$a$及び奇素数$p$について
\begin{align*}
\left(\frac{a}{p}\right) =
\begin{cases}
0, &\mbox{if }a \equiv 0 \pmod{p}\\
1, &\mbox{if }\exists x \mbox{ s.t. } x^2 \equiv a \pmod{p}\\
-1, &\mbox{otherwise}
\end{cases}
\end{align*}
と定義される。
\end{Defi}

Legendre記号を使えば、例えば、\rProp{quadratic_residue_product}の1は、
\begin{align*}
\left(\frac{a}{p}\right)\left(\frac{b}{p}\right) = \left(\frac{ab}{p}\right)
\end{align*}
と書き直せる\Notes{厳密には$a\equiv0\pmod{p}$のケースを議論していないが、脇に除ける。}。

\subsubsection{平方剰余の相互法則}
これまで平方剰余の性質について見てきたが、整数$a$と奇素数$p$が与えられたとき、$a$が$p$を法とする平方剰余か否かを判別する(別の言い方をすれば、Legendre記号$\left(\frac{a}{p}\right)$の値を得る)にはどうしたらよいだろうか。
愚直には、1～$p-1$までの数をそれぞれ2乗し、$a$になるかを確認すればよい。
$p$が小さいうちは何とかなるかもしれないが、$p$が大きくなると手に負えそうにない。
実はわりと簡単に計算することができる次の方法が知られていて、それが\IND{Eulerの規準}{Eulerのきしゆん}(Euler's criterion)とも呼ばれている。

\begin{Prop}{}{Legendre_symbol_calc}
Legendre記号$\left(\frac{a}{p}\right)$は、整数$a$及び奇素数$p$について、次の式で計算できる。
\begin{align*}
\left(\frac{a}{p}\right) \equiv a^{(p-1)/2} \pmod{p}
\end{align*}
\end{Prop}

既に述べたように、$\mathbb{Z}_p^*$の元は、$p$を法として平方剰余か平方非剰余かで丁度2つに分けられ、どちらが多くも少なくもない。
実は$p$を法とする平方剰余(あるいは平方非剰余)を1つ示せ、という問題に答える確定的アルゴリズムは知られていないのだが、個数は分かっているので、ランダムに選んで平方剰余かを判定すれば、$1/2$の確率で所望の結果が得られるわけだ。
実用的には数回試行すれば事足りるので十分効率的であると言える。

余談となるが、平方剰余と平方剰余を掛けたものもまた平方剰余であるため、平方剰余の集合$\mathbf{QR}_p$は乗法について群を成す。
一方、平方非剰余の集合$\mathbf{QNR}_p$は群にならないが、これがなぜかというのは群の良い復習になる。
$1$は常に平方剰余であり、つまり、平方非剰余の集合に単位元が存在しないと言うことは、群の定義を満たさないのである。

さて、Legendre記号を求めるアルゴリズムは、\rProp{Legendre_symbol_calc}を素直に実装すると、次の通りとなる。

\Algo{Eulerの規準}{euler_criterion}{}

以上のように、素数を法とする平方剰余の判定は簡単に行うことができるのである。
平方剰余の理論は、次に示す平方剰余の相互法則によって、1つの頂点を迎える。
後に、三次や四次の相互法則に拡張され、より一般的な相互法則を見出す作業は、19世紀の数学者にとって大きな目標となった。
代数的整数論における記念碑的定理である。

\begin{Theo}{Legendre記号に対する\IND{平方剰余の相互法則}{へいほうしようよのそうこほうそく}, quadratic reciprocity}{legendre_quadratic_reciprocity}
$p,q$を2より大きい素数とする。
このとき、次が成り立つ。
\begin{align*}
\left(\frac{p}{q}\right)\left(\frac{q}{p}\right) = (-1)^{\frac{p-1}{2}\frac{q-1}{2}}
\end{align*}
\end{Theo}

普通の教科書ならば、順を追って証明するのだが、ここでは紹介のみに留め、次に進もう。
素数を法とする平方剰余の判定ができたのだから、次は整数について同じようにと考えることもできる。
しかし、これから進む道は別の道である。
Legendre記号を拡張することによって、素数を法とする平方剰余の判定を更に高速化できないか、という方向を考えるのである。

\subsubsection{Jacobi記号}
まず、Jacobi記号を定義する。

\begin{Defi}{\IND{Jacobi記号}{Jacobiきこう}, Jacobi symbol}{Jacobi_symbol}
Jacobi記号$\left(\frac{a}{m}\right)$は、整数$a$及び奇数$m$について
\begin{align*}
\left(\frac{a}{m}\right) = \prod_{i = 1}^r \left(\frac{a}{p_i}\right)^{e_i}
\end{align*}
と定義される。
ただし、$m=p_1^{e_1}\cdot\cdots\cdot p_r^{e_r}$と素因数分解できるとする。
また、右辺はLegendre記号である。
\end{Defi}

Legendre記号とJacobi記号で、同じ記号を使うものだから混乱しやすい。
その点は、どうしようもないことなので、「同じ記号であっても別物である」ということを念頭に置いて理解する必要がある。

\begin{Exam}{}{}
\begin{align*}
\left(\frac{4}{45}\right) &= \left(\frac{4}{3}\right)^2\left(\frac{4}{5}\right)\\
&= (1)^2(1) = 1
\end{align*}
\end{Exam}

Jacobi記号は、Legendre記号の積として定義されたことを思い出せば、計算結果は$-1,0,1$のいずれかになるはずである。
そうすると、(Legendre記号と同様に)Jacobi記号が平方剰余か否かを表しているように早合点してしまいがちだ。
しかし、\textbf{Jacobi記号の値が平方剰余かどうかを示すわけではない}ということは予め断っておく。
Jacobi記号とLegendre記号の関係を知るには、次の2つの性質が重要である。

\begin{Prop}{}{jacobi1}
$m$が素数ならば、Jacobi記号$\left(\frac{a}{m}\right)$とLegendre記号$\left(\frac{a}{m}\right)$は、任意の$a$について一致する。
\end{Prop}

素数ならばLegendre記号と一致する、ということは定義から一目瞭然であるが、言い方を変えれば、Legendre記号が定義する範囲内においてはJacobi記号を代用しても構わない、と考えることもできる。
もう1つは、Jacobi記号の値が平方剰余かどうかを示すわけではないということだ。

\begin{Prop}{}{jacobi2}
整数$a$及び奇数$m$について、Jacobi記号$\left(\frac{a}{m}\right)$が$-1$になるとき、$a$は$m$を法として平方非剰余であるか$a$と$m$は互いに素でない。
\end{Prop}

奇数の合成数の時にも、一定の場合平方非剰余の判定に利用できることが分かるが、この命題の逆、つまり、Jacobi記号が1になったからと言って、平方剰余であるとは限らない。
実際、$2$は$15$を法として平方非剰余であるが、
\begin{align*}
\left(\frac{2}{15}\right) &= \left(\frac{2}{3}\right)\left(\frac{2}{5}\right)\\
&= (-1)(-1)\\
&= 1
\end{align*}
となる。
何度も確認してそろそろ鬱陶しいと思うが、左辺はJacobi記号で、右辺はLegendre記号である。

そういうわけで、Jacobi記号が平方剰余判定に対して、そこまで強力な武器ではないように見えるし、Jacobi記号の計算するにしても$m$の素因数分解を行う必要があるように見える。
しかしJacobi記号は、$m$の素因数分解を行うことなく計算することができる。
それを説明するためには、Jacobi記号の性質について理解する必要がある。

\begin{Prop}{}{}
1より大きい奇数$n,m$および整数$a,b$について次が成り立つ。
\begin{enumerate}
\item $a\equiv b \pmod{n}$ならば、$\left(\frac{a}{n}\right)=\left(\frac{b}{n}\right)$
\item $\left(\frac{ab}{n}\right)=\left(\frac{a}{n}\right)\left(\frac{b}{n}\right)$
\item $\left(\frac{a}{nm}\right)=\left(\frac{a}{n}\right)\left(\frac{a}{m}\right)$
\end{enumerate}
\end{Prop}

更に、Jacobi記号にも平方剰余の相互法則が成り立つ。

\begin{Theo}{Jacobi記号に対する\IND{平方剰余の相互法則}{へいほうしようよのそうこほうそく}, quadratic reciprocity}{jacobi_quadratic_reciprocity}
$n,m$を互いに素な1より大きい奇数とする。
このとき、次が成り立つ。
\begin{align*}
\left(\frac{m}{n}\right)\left(\frac{n}{m}\right) = (-1)^{\frac{n-1}{2}\frac{m-1}{2}}
\end{align*}
\end{Theo}

以上の性質を用いると、Jacobi記号は次のアルゴリズムで計算できる。

\Algo{Jacobi記号}{jacobi_symbol}{}

\rAlgo{jacobi_symbol}は、\rAlgo{legendre_symbol}より高速に計算できる。
そして、\rProp{jacobi1}より素数の範囲においてLegendre記号とJacobi記号は一致する。
ならば、Legendre記号$\left(\frac{a}{p}\right)$を計算する際は、\rAlgo{jacobi_symbol}を使った方がよい、というのがJacobi記号を導入した1つの成果である。
一方で、別の見方もできる。
$m$が素数のとき、$\left(\frac{a}{m}\right)$は、\rAlgo{legendre_symbol}も\rAlgo{jacobi_symbol}でも同じ結果になるが、$m$が合成数のとき\textbf{一致しないこともある}。
素数と合成数で異なる挙動を示すということは、素数判定に使えるのではないかというアイディアが浮かぶ。

\subsubsection{Solovay-Strassenテスト}
\IND{Solovay-Strassenテスト}{Solovay-Strassenてすと}(Solovay-Strassen primality test)\cite{DBLP:journals/siamcomp/SolovayS77}は、Eulerの規準とJacobi記号の振舞いの違いに着目する。
$n$が素数の場合、この2つは常に一致するが、合成数の場合はそうではない。
$a$の値によって一致することもあるし、一致しないこともある。
この一致する$a$と一致しない$a$は、丁度半分ずつ存在するので、$a$をランダムに選べば$1/2$の確率で合成数であることが分かるのである。

\Algo{Solovay-Strassenテスト}{solovay_strassen_test}{c.f., \rAlgo{euler_criterion}, \rAlgo{jacobi_symbol}}

Solovay-Strassenテストを突破する合成数を\IND{Euler-Jacobi擬素数}{Euler-Jacobiきそすう}(Euler-Jacobi pseudoprime)と呼ぶ\Notes{単にEuler擬素数と呼ぶ流儀もある。}。

\subsubsection{Tonelli-Shanksのアルゴリズム}
余勢を駆って、具体的な平方根を求めるアルゴリズムにも言及しよう。
Legendre記号は平方剰余かを判定できたが、それがどんな数かは分からなかった。
\IND{Tonelli-Shanksのアルゴリズム}{Tonelli-Shanksのあるこりすむ}(Tonelli-Shanks algorithm)は素数$p$を法とする$a$の平方根を具体的に求めるアルゴリズムである。

$a$は当然、平方剰余を仮定してよい。
つまり、$\left(\frac{a}{p}\right)=1$である。
Eulerの規準(\rProp{Legendre_symbol_calc})より$t=(p-1)/2$と置くと、
\begin{align*}
a^t &\equiv 1 \pmod{p}\\
a^{t+1} &\equiv a \pmod{p}\\
a^{(t+1)/2} &\equiv a^{1/2} \pmod{p}
\end{align*}
となり、求めたい平方根は$a^{(t+1)/2}$であることが分かる。
とても簡単に求めてしまったように思えるが、もちろん落とし穴があって、ちょっと考えればすぐに$(t+1)/2$が整数とならなければ計算できないことに気付く。
それでも、$(t+1)/2$が整数になる、言い換えれば$p\equiv3\pmod{4}$の場合のアルゴリズムは得た。

この考察を一般化しよう。
$p-1$は$2^s\cdot t$と書けるとする(ここで$t$は奇数)。
$a^t \equiv D^{-2\mu}\pmod{p}$を満たす$D,\mu$が\kenten{与えられたとすれば}、先ほどと同様の議論により、
\begin{align*}
a^t &\equiv D^{-2\mu}\pmod{p}\\
a^tD^{2\mu} &\equiv 1 \pmod{p}\\
a^{t+1}D^{2\mu} &\equiv a \pmod{p}\\
a^{(t+1)/2}D^{\mu} &\equiv a^{1/2} \pmod{p}
\end{align*}
となって$a$の平方根は$a^{(t+1)/2}D^{\mu}$であることが分かる。

となれば、次は$D,\mu$を求める方法を考えるわけだが、ここでは次の命題が正しいとしてアルゴリズムを与える。

\begin{Prop}{}{tonelli_shanks_algorithm}
$p$を奇素数、$d\in\mathbf{QNR}_p$とする。
$p-1=2^s\cdot t$と書ける(ここで$t$は奇数)とし、$A\equiv a^t\pmod{p},D\equiv d^t\pmod{p}$と置く。
$0\le k<s$について、$(AD^m)^{2^{s-k}}\equiv1\pmod{p}$ならば、$(AD^m)^{2^{s-(k+1)}}\equiv\pm1\pmod{p}$である。
特に$-1$のとき、$m'=m+2^k$とすると、$(AD^{m'})^{2^{s-(k+1)}}\equiv1\pmod{p}$である。
\end{Prop}

$k=0,m=0$のとき、$(AD^m)^{2^{s-k}}\equiv1\pmod{p}$を満たすので、あとは$k$を大きくしながら常に1になるように$m$を書き換えてやればよい。
最終的に$AD^m\equiv1\pmod{p}$を満たす$m$が見つかるが、これは$2\mu$に他ならない。

Tonelli-Shanksのアルゴリズムは、任意の奇素数$p$で正しく平方根を返すので\rProp{tonelli_shanks_algorithm}を実装するだけでもよいのだが、$p\equiv3\pmod{4}$ならもっと簡単な方法があるので、コードの簡潔さは劣るが高速化のためにはそちらを使った方が良い。

\Algo{Tonelli-Shanksのアルゴリズム}{tonelli_shanks_algorithm}{c.f., \rAlgo{find_qnr}, \rAlgo{jacobi_symbol}, \rAlgo{split_int}}

これは、あくまで素数を法とする平方根を求める方法であることに注意する。

\subsubsection{平方数を判定する}
\label{sssec:quadratic_residue_square}
$n$が平方数であるかは、$n$の平方根の整数部分を2乗して$n$に一致しているかを確認すればよい。
これだけでも十分に速いのだが、平方剰余の知識を使えば、もっと高速化できる。
整数で平方数なら、$m$を法としても平方剰余となるから、逆に$m$を法として平方非剰余なら$n$は平方数にならない、と言えるのだ。

\begin{Prop}{}{}
正整数$m$について\Notes{これまで$m$は、奇素数や奇数で考えてきたが、平方剰余の概念は任意の正整数で定義できることに注意する。}、正整数$n$が$m$を法として平方非剰余ならば、$n$は平方数ではない。
\end{Prop}

特に$m$が小さいときは簡単な条件文で記述できる。

\begin{itemize}
 \item $n\equiv2\pmod{3}$ならば、$n$は平方数ではない。
 \item $n\equiv2,3\pmod{5}$ならば、$n$は平方数ではない。
 \item $n\equiv3,5,6\pmod{7}$ならば、$n$は平方数ではない。
 \item $n\equiv0,1,4\pmod{8}$\kenten{でない}ならば、$n$は平方数ではない。
\end{itemize}

もっと大きな$m$でも同じように考えることはできるが、条件数が増えてしまうためトータルで高速化に寄与しない。

\Algo{平方数判定}{is_square_number}{c.f., \rAlgo{sqrt_int}}

平方数判定の高速化は、Fermat法に恩恵を与える。
Fermat法に応用できる考えはそれだけではなく、平方剰余によってそもそもチェックしなくてもよい数が明らかになるのである。
Fermat法では、$x^2-n$が平方数かを常にチェックする必要があったが、上記の考えを適用すれば、例えば$x^2-n\equiv2\pmod{3}$なら平方数にならない。
$n\equiv2\pmod{3}$とすると、$x\equiv0\pmod{3}$でなければならないことが分かる。
つまり、$x$は3の倍数のみを考えばよく、これだけで探索範囲は$1/3$となる。
$n\equiv1\pmod{3}$の場合は逆に$y$が3の倍数であることが示せるので、$x^2-n$は9の倍数でなければならない。

\begin{Prop}{}{}
$n$は2でも3でも割り切れない正整数とする。
$x^2-n$が平方数であるとき、次を満たす。
\begin{itemize}
 \item $n \equiv 1 \pmod{3}$ならば、$x^2 \equiv n \pmod{9}$
 \item $n \equiv 2 \pmod{3}$ならば、$x \equiv 0 \pmod{3}$
\end{itemize}
\end{Prop}

もう少し考えると、次のことが分かる。

\begin{itemize}
 \item $n \equiv 11 \pmod{24}$ならば、$x \equiv 6 \pmod{12}$
 \item $n \equiv 23 \pmod{24}$ならば、$x \equiv 0 \pmod{12}$
 \item $n \equiv 5 \pmod{12}$ならば、$x \equiv 3 \pmod{6}$
 \item $n \equiv 3 \pmod{8}$ならば、$x \equiv 2 \pmod{4}$
 \item $n \equiv 7 \pmod{8}$ならば、$x \equiv 0 \pmod{4}$
 \item $n \equiv 1 \pmod{4}$ならば、$x \equiv 1 \pmod{2}$
\end{itemize}

これを実装すると、次のようになる。

\Algo{Fermat法(高速化版)}{fermat_factorization_method_fast}{c.f., \rAlgo{sqrt_int}}

また、$x^2-n$が平方数にならなくとも、いくつかの情報は得られる。
例えば、$x^2-n=17$だったとしよう。
$n$の素因数$p$で剰余算すれば、$x^2\equiv17\pmod{p}$が得られるので、$p=17$でなければ$p\equiv\pm1,\pm2,\pm4,\pm8\pmod{17}$である。
一般に、$x^2-n=q$が得られたとき、$q$が素数で$q \not\mid n$かつ$4 \mid q-1$ならば、$n$の素因数$p$は$\left(\frac{p}{q}\right)=1$を満たす\Notes{$x^2\equiv q\pmod{p}$より、$\left(\frac{q}{p}\right)=1$。平方剰余の相互法則より、$\left(\frac{p}{q}\right)=1$}。
これは$n$の素因数候補が半分になるということで、同様の合同式を複数得れば指数関数的に候補が絞られていく強力な手法である。
合同式をすべて満たす解を見つける計算量が指数関数的に増大する点を除いては――。

\subsubsection{擬平方数}
整数で平方数なら、$m$を法としても平方剰余となるから、逆に$m$を法として平方非剰余なら$n$は平方数にならない、ということを利用して平方数判定を高速化した。
ならば、どんな法でも平方剰余となる、平方数でない数とはどのようなものであろうか。

\begin{Defi}{\IND{擬平方数}{きへいほうすう}, pseudosquare}{pseudosquare}
素数$p$に対する擬平方数$L_p$は、次の2条件を満たす平方数でない最小の正整数である。
\begin{enumerate}
 \item $L_p \equiv 1 \pmod{8}$
 \item $2<q\le p$を満たすすべての素数$q$について、$\left(\frac{L_p}{q}\right)=1$
\end{enumerate}
\end{Defi}

\begin{Exam}{}{pseudosquare}\;
\begin{itemize}
 \item $8k+1$の形の正整数で平方数でない最小の数は$17$である。よって、$L_2 = 17$
 \item $L_3 = 73$
  \begin{itemize}
   \item $\left(\frac{17}{3}\right)=\left(\frac{41}{3}\right)=\left(\frac{65}{3}\right)=-1$
   \item $\left(\frac{33}{3}\right)=\left(\frac{57}{3}\right)=0$
   \item 25,49は平方数
  \end{itemize}
 \item $L_5 = 241$
\end{itemize}
\end{Exam}

計算機実験の結果から、$p$に対する$L_p$の値は指数関数的に増加することが予想されている。
そのせいもあって、$L_p$の厳密な値が知られているのは$p=373$までである\cite{10.1007/978-3-642-14518-6_26}\Notes{\url{http://oeis.org/A002189}}。
一方で、擬平方数を素数判定に応用する際には、この増加速度は有利に働く。

\begin{Theo}{\cite{Lukes1996}}{pseudosquare_test}
$n$を1より大きい奇数、$B$を正整数、$p$を素数とする。
次の条件をすべて満たすなら$n$は素数か素数の累乗である。
\begin{enumerate}
 \item $n$の素因数はすべて$B$より大きい。
 \item $n < BL_p$
 \item $q \le p$を満たす任意の素数$q$について、$q^{(n-1)/2}\equiv \pm1\pmod{n}$
 \item $n\equiv 5\pmod{8}$ならば、$2^{(n-1)/2}\equiv-1\pmod{n}$
 \item $n\equiv 1\pmod{8}$ならば、$q^{(n-1)/2}\equiv -1\pmod{n}$を満たす奇素数$q \le p$が存在する。
\end{enumerate}
\end{Theo}

特に$B=1$のとき、\rTheo{pseudosquare_test}は必要十分条件となって、確定的な素数判定法を与える。

\Algo{擬平方数による素数判定}{pseudosquare_test}{c.f., \rAlgo{is_perfect_power}}


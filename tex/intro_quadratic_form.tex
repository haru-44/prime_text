2次形式とは、次数が2の斉次多項式である(ここでは変数が2つの2元2次形式を単に2次形式と呼ぶ)。
つまり、
\begin{align*}
ax^2 + bxy + cy^2
\end{align*}
という形の多項式に関する理論であり、数学の広範な分野において重要な概念である。
もちろん、本稿で取り上げるからには素因数分解にも利用できる。
例えば$n=1000009$は、$n=1000^2+3^2$と$n=972^2+235^2$という2種類の表し方があるが、これを見つけることができれば、$\gcd(n, 1000\cdot235 - 3\cdot972)$を計算することによって、非自明な約数$3413$を発見できる。
つまり、$n$の2種類の異なる平方数の和で表すことができれば、素因数分解ができるのである。
このような素因数分解法は、\IND{Euler法}{Eulerほう}(Euler's factorization method)と呼ばれている。
$x^2+y^2$は、$a=c=1,b=0$であるような2次形式であるから、Euler法と2次形式は関係があるように思える。

改めて、2次形式を定義しよう。

\begin{Defi}{\IND{2元2次形式}{2けん2しけいしき}, binary quadratic form}{binary quadratic form}
\begin{align*}
f(x,y) = ax^2 + bxy + cy^2
\end{align*}
という形の2変数多項式を2元2次形式、あるいは単に2次形式(quadratic form)と呼ぶ。
簡単のため$f=(a,b,c)$と表す。
\end{Defi}

2元2次形式という所から察せられる通り、$n$元2次形式も存在し、$n$を一般化した理論を2次形式と呼ぶこともあるが、ここでは2元2次形式のことを指して2次形式と呼ぶ。
2次形式は行列で定義することもできて、実際、
\begin{align*}
ax^2 + bxy + cy^2 &= ax^2 + \frac{b}{2}xy + \frac{b}{2}yx + cy^2\\
&=
\begin{pmatrix}
x & y
\end{pmatrix}
\begin{pmatrix}
a & \frac{b}{2}\\
\frac{b}{2} & c
\end{pmatrix}
\begin{pmatrix}
x\\
y
\end{pmatrix}
\end{align*}
である。
行列から見ると$b/2$は不格好なので、2次形式を$ax^2+2bxy+cy^2$と定義する流儀もあって、そうすれば
\begin{align*}
\begin{pmatrix}
a & b\\
b & c
\end{pmatrix}
\end{align*}
と簡明な行列となる。
2次形式は、1798年に Legendre が出版した『整数の理論の試作』(Essai sur la Théorie des Nombres)において理論の大部分が創り上げられ、Gaussの『整数論』(Disquisitiones Arithmeticae)\Notes{Gauss唯一の著作にして不朽の名著である。『数論研究』や『ガウス整数論』とも訳される。}で本格的に完成したとされる。
そのGaussが$xy$の係数に2が付いている定義を使っており、どちらを定義として採用するかは理論の誕生初期から混乱が生じてきた。
ここでは、$xy$の係数に2が付いていない定義で話を進めるので、その点には注意して欲しい。

Euler法は、$n$から$n=x^2+y^2$となる$x,y$を見つけることを試みたが、すべての合成数$n$について、そのような$x,y$は存在するのだろうか？　この疑問を考察するために、我々は$x,y$に整数を与えたとき、$f(x,y)$がどの整数を取るのかを考えたい。
例えば、$4x^2+3xy+2y^2$は、$x=y=1$のとき$9$になるが、$x,y$を整数の範囲でどんなに動かしても$1$にはならない。

\begin{Defi}{}{qf_representation}
整数$n$が2次形式$f(x,y)=ax^2+bxy+cy^2$で表現可能であるとは、整数$x,y\in\mathbb{Z}$が存在して、$n=f(x,y)$を満たすことである。
\end{Defi}

一方で、見た目が異なる2次形式でも、表現可能な整数の集合は一致する場合がある。
例えば、$(1,0,5)$と$(1,2,6)$は見た目こそ異なるが、表現可能な整数の集合は一致する。
どのような場合に、そうなるのだろうか？　それを考察するには、行列表現の方が見通しが良い。

\begin{Prop}{}{}
2つの2次形式$(a,b,c), (a',b',c')$の表現可能な整数の集合が一致するとき、かつそのときのみ、$\alpha\delta-\beta\gamma=\pm1$で、
\begin{align*}
\begin{pmatrix}
\alpha & \beta\\
\gamma & \delta
\end{pmatrix}^T
\begin{pmatrix}
a & \frac{b}{2}\\
\frac{b}{2} & c
\end{pmatrix}
\begin{pmatrix}
\alpha & \beta\\
\gamma & \delta
\end{pmatrix}
=
\begin{pmatrix}
a' & \frac{b'}{2}\\
\frac{b'}{2} & c'
\end{pmatrix}
\end{align*}
を満たす整数$\alpha, \beta, \gamma, \delta$が存在する。
\end{Prop}

同じことだが、成分がすべて整数で行列式が$\pm1$を満たす行列$M$を使って、$M^TAM$と変換される2次形式は、$A$と表現可能な整数の集合が一致する。
行列式が$-1$の場合の変換はあまり面白くないので、以降は行列式が$+1$の変換のみを扱う。

\begin{Defi}{}{qf_iff}
2次形式$f=(a,b,c),g=(a',b',c')$が行列式$+1$の変換で結ばれているとき、2つの2次形式は同値(equivalent)であるという。
\end{Defi}

行列式は乗法的(つまり、$\det(AB)=\det(A)\det(B)$)であるので、同値な2次形式というのは行列式も一致している。
さて、行列
\begin{align*}
\begin{pmatrix}
a & \frac{b}{2}\\
\frac{b}{2} & c
\end{pmatrix}
\end{align*}
の行列式は、$ac-b^2/4$である。
つまり厄介なことに、$a,b,c$が整数であっても行列式は整数にならないことが起こり得る。
そこで、$-4$をかけて常に整数になるように変更を加えてこれを判別式と呼ぶことにしよう。

\begin{Defi}{\IND{判別式}{はんへつしき}, discriminant}{qf_det}
$D=b^2-4ac$を2次形式$f=(a,b,c)$の判別式と呼ぶ。
\end{Defi}

こうすれば、同値か同値でないかを一目で分かるようにすることに対して、判別式は部分的な結論を与える。

\begin{Prop}{}{qf_det}
2次形式$f=(a,b,c),g=(a',b',c')$が同値ならば、2つの判別式は一致する。
\end{Prop}

注意が必要なのは、逆は成り立たないことだ。
例えば、$(1,1,4)$と$(2,1,2)$は共に$D=-15$だが、前者は1を表現可能であるのに対して後者は表現できないので、これらは同値ではない。

以上で、2次形式を語る上では欠かせない重要な数値である判別式を導入した。
特に、$D$が正か負かで話はまったく変わってくるのだが、本稿では$D<0$のみを扱う。
さらに$D$が負の場合、$(a,b,c)$と$(-a,-b,-c)$は符号を反転しただけに過ぎないので、$a>0$のみを考える。

判別式は同値か同値でないかを見分けるには今一つ役に立たないように思える。
それならば、同値な2次形式は1つの形で表すことはできないだろうか。
例えば分数では、$2/4$も$10/20$も同じ数を表して、$1/2$とするのが良いように、2次形式でも標準的な形のようなものがあれば嬉しい。
それが簡約形式と呼ばれるもので、分数で言うところの既約分数にあたると言えるだろう。

\begin{Defi}{}{qf_reduction}
負の判別式で$a>0$である2次形式$(a,b,c)$が簡約形式であるとは、次を満たすことを言う。
\begin{align*}
-a < b \le a < c \mbox{ または } 0 \le b \le a = c
\end{align*}
\end{Defi}

簡約形式にするのも、次のようにしてできる。

\Algo{2次形式の簡約}{quadratic_form_reduction}{}

簡約形式の嬉しさは、$a,b$の大きさが$D$によって制限されることである。
つまり、$(a,b,c)$が簡約形式であるとき、
\begin{align*}
|a| \le \sqrt{\frac{|D|}{3}}
\end{align*}
を満たす。

次に、$D$毎に2次形式を分類することを試みる。
$D<0$かつ$D\equiv0,1\pmod{4}$なる$D$について、$\mathcal{C}(D)$は次のような2次形式$(a,b,c)$の集合と定義する。
\begin{itemize}
 \item 判別式は$D$
 \item $a>0$
 \item $(a,b,c)$は簡約形式
 \item $\gcd(a,b,c)=1$
\end{itemize}

念のため補足するが、簡約形式であることと$\gcd(a,b,c)=1$は同値ではない。
例えば、$(4,4,6)$は$D=-60$の簡約形式だが、$\gcd(a,b,c)=1$ではないので、$\mathcal{C}(-60)$には属さない。
また、$D\equiv0,1\pmod{4}$に限定しているのは、$D\equiv3,4\pmod{4}$になるような2次形式がそもそも存在しないためである\Notes{$D=b^2-4ac$であるが、$b^2\equiv0,1\pmod{4}$かつ$4ac\equiv0\pmod{4}$}。

ごちゃごちゃ言うよりも実例を見た方が早いだろう。

\begin{align*}
\mathcal{C}(-3) &= \{(1,1,1)\}\\
\mathcal{C}(-4) &= \{(1,0,1)\}\\
\mathcal{C}(-15) &= \{(1,1,4), (2,1,2)\}\\
\mathcal{C}(-23) &= \{(1,0,6), (2,1,3), (2,-1,3)\}\\
\end{align*}

$|a| \le \sqrt{\frac{|D|}{3}}$であることから、$D$が小さければ$\mathcal{C}(D)$の元を枚挙することは可能だ。
ナイーブなアルゴリズムを次のように構成できる。

\Algo{$\mathcal{C}(D)$の元を枚挙する}{quadratic_form_class_number_naive}{c.f., \rAlgo{sqrt_int}}

ここまでの準備によって、改めて2次形式で表現可能な$n$について考えたい。
$D$と$n$を与えられたとき$D$を判別式とする2次形式で$n$が表現可能か？　という問題に対しては、次の定理が知られている。

\begin{Theo}{}{quadratic_form_and_quadratic_residue}
\begin{align*}
h^2 \equiv D \pmod{4n}
\end{align*}
を満たすような$h$が存在すれば、$D$を判別式とするある2次形式が存在し、$n$を表現可能である。
\end{Theo}

\begin{thProof}{quadratic_form_and_quadratic_residue}
$h^2 \equiv D \pmod{4n}$を満たすような$h$が存在するとする。
すると、$h^2 = D + 4nA$を満たす$A$が存在する。
$(A,h,n)$は判別式$D$の2次形式であり、$x=0,y=1$のとき$n$を表示する。
\end{thProof}

定理中では「ある2次形式」となっているが、特に$\sharp\mathcal{C}(D)=1$のときは1つの2次形式に限定されて、必要十分条件となる。
例えば、有名な定理としてFermatの二平方定理\Notes{有名な問題であるが、定まった名前がない。}もこの定理から証明できる。

\begin{Theo}{\IND{Fermatの二平方定理}{Fermatのにへいほうていり}, Fermat's theorem on sums of two squares}{Fermat's_theorem_on_sums_of_two_squares}
奇素数$p$が整数$x,y$によって
\begin{align*}
x^2 + y^2 = p
\end{align*}
と表されるとき、かつそのときのみ、$p\equiv1\pmod{4}$を満たす。
\end{Theo}

$x^2+y^2$が$(1,0,1)$という2次形式であること、そしてこの2次形式の判別式が$D=-4$であることから、$h^2\equiv-4\pmod{4n}$を満たす$h$が存在するという条件が必要にして十分である($\sharp\mathcal{C}(-4)=1$に注意する)。

これは奇素数の場合の結果だが、$n$が合成数の場合でも、常に$n=x^2+y^2$となるような$x,y$が存在するとは限らない。
つまり、このことは、最初に紹介したEuler法がどんな合成数にも適用できる素因数分解法でないことが分かる。
しかし、がっかりするのはまだ早い。
2次形式を通してEuler法をもう一度眺めてみると、Euler法は分解したい数$n$の2次形式$(1,0,1)$による異なる表示を求めている。
$(1,0,1)$に限定することに無理があったのであって、2次形式一般に同様の議論ができないだろうか。

(混乱しないように明言しておくが)$n,D$は固定して話を進める。
我々は既に、$h^2\equiv D \pmod{4n}$なる$h$を見つければ、$n$を表示する2次形式$(a,b,c)$を得ることができる。
これは、イメージだけで言えば「$h$の世界」と「2次形式の世界」とに橋が架かっている状態と言える。
更に、「2次形式の世界」と
\begin{align*}
u^2 \equiv Dv^2 \pmod{4n}
\end{align*}
を満たす「解$(u,v)$の世界」に橋を架ければ、「$h$の世界」から「$(u,v)$の世界」までの経路が完成する。

\begin{Prop}{}{quadratic_form_1}
判別式$D$の2次形式$(a,b,c)$が、整数$n$を$ax^2+bxy+cy^2=n$と表示するとき、
\begin{align*}
u^2 \equiv Dv^2 \pmod{4n}
\end{align*}
を満たす解$u,v$が存在する。
\end{Prop}

\begin{prProof}{quadratic_form_1}
$ax^2+bxy+cy^2=n$の両辺に$4a$を掛けて整理すると、
\begin{align*}
(2ax + by)^2 -Dy^2 = 4an
\end{align*}
が得られる。
$u=2ax + by, v=y$と置くと、$u^2 - Dv^2\equiv0\pmod{4n}$の解$(u,v)$が得られる。
\end{prProof}

1つの結論は、「$h$の世界」で本質的に異なる2つの$h$さえ見つければ、それぞれの$h$から求められる$(u,v)$を使って$n$の非自明な約数を見つけられるということだ。

\begin{Prop}{}{sq_div}
$n$は$\sqrt{|D|}$以下の素数では割り切れないとする。
$h_i(i=1,2)$を$h_i^2\equiv D\pmod{4n}$の解で、$h_1\not\equiv\pm h_2\pmod{n}$を満たすとする。
上記の設定の下、$h_i$から得られる$u_i^2 \equiv Dv_i^2 \pmod{4n}$の解を$(u_i,v_i)$とすると、$\gcd(u_1v_2 - u_2v_1, n)$は$n$の非自明な約数である。
\end{Prop}

ただし、これから紹介する素因数分解アルゴリズムにおいて、陽に$h$を求めるわけではない。
合成数なら、必ずこのアルゴリズムで分解できることを保証する理論的な道具として登場するに過ぎない。
McKee\cite{10.1112/blms/28.4.351}のアイディアは、$(u,v)$を虱潰しに調べるのだが、2次形式の理屈によると、調べる範囲を相当に絞ることができるというものである。
適当な$D<0$を固定しよう(後でどのような値にすればよいか改めて考察する)。
判別式が$D$であるような簡約形式は、$1\le a\le\sqrt{|D|/3}$を満たす。
さらに、$|u|\le2\sqrt{an}$を満たすことにも注意すると、$a$と$u$の動ける範囲はかなり限定される。
また、$u^2\equiv4an\pmod{|D|}$および$v^2=(u^2-4an)/D$は平方数であるという条件も使えるだろう。
計算量は$D$の大きさに依存するのだが、$|D|$が小さいと$a$の範囲は狭くなるが、$u$の候補が膨大になるし、$|D|$が大きいと$a$は$\sqrt{|D|/3}$まで調べなければならない。
結局、折り合いが付くのは$|D|$が$n^{2/3}$程度のときで、このとき$O(n^{1/3+\epsilon})$で分解できる。
$D$の決め方は、$x_0=\left \lfloor \sqrt{n-n^{2/3}} \right \rfloor, d=n-x_0^2, D=-4d$とおけば条件を満足する。
しかも、2次形式$(1,0,d)$は簡約形式で$x=x_0,y=1$のとき$n$を表示する。
よって、$u=2x_0,v=1$は、$u^2 \equiv Dv^2 \pmod{4n}$の解である。
こうして、労せずに探していた1つが見つかった。
後は、もう1組の$(u,v)$を見つけるだけである。

だが、これで問題がすべて解決したわけではない。
$u^2\equiv4an\pmod{|D|}$を満たす$u$はどのようにして見つければ良いのだろうか？　既に$\bmod$が素数の場合の平方根の求め方は学んだ(\rAlgo{tonelli_shanks_algorithm}, \rAlgo{cipolla_algorithm})。
これを合成数一般に拡張するのは、ある意味困難だ。
というのも、$\bmod$が合成数$n$の平方根を計算する難しさは、$n$を素因数分解する難しさと等価であることが知られているからだ。
逆に考えれば$n$の素因数分解さえ分かってしまえば簡単に解けるということでもある。

\Algo{$\bmod{n}$での平方根}{sqrt_modulo}{c.f., \rAlgo{chainese_remainder_theorem}, \rAlgo{cipolla_algorithm}, \rAlgo{inverse_mod}, \rAlgo{jacobi_symbol}}

ただし、ここで紹介したアルゴリズムでも不十分で、$x^2\equiv a\pmod{n}$の$x$を求めようとするとき$a$と$n$が互いに素でない場合に上手く動かない。
次のMcKee法の実装では、sympyのメソッドを使用して平方根を求めているが、内部では毎回$D$の素因数分解を行うためまったく効率的ではない。

\Algo{McKee法}{mckee_method}{c.f., \rAlgo{is_square_number}, \rAlgo{nth_root_int}, \rAlgo{sqrt_int}}

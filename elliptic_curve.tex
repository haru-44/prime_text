まず、「楕円曲線」とは、
\begin{align}
\label{eq:elliptic_curve_1}
y^2 = x^3 + ax + b
\end{align}
と書ける方程式、あるいは同じことであるが、
\begin{align}
\label{eq:elliptic_curve_2}
y^2 = x^3 + Cx^2 + Ax + B
\end{align}
と書ける方程式のことである。
厳密には、「標数が2でも3でもないとき」などの前置きが必要になるが、ここでは一旦忘れる。
$a,b$や$A,B,C$の値によって曲線の形は様々に変わり得るが、多くの類書が注意するようにこの形が楕円であるわけではない。
古くは、楕円の弧長を求める際に必要となる\IND{楕円積分}{たえんせきふん}(elliptic integral)に端を発し、Niels Abelによって、楕円積分の逆関数として\IND{楕円関数}{たえんかんすう}(elliptic function)が発見されたという歴史がある故である。
楕円積分は、高校で習う程度の積分テクニックでは太刀打ちできない難物で、Legendreは、Legendre記号(\rDefi{Legendre_symbol})などに名を残す偉大な数学者であるが、彼の生涯の大部分を費やしても\kenten{楕円積分そのものを考えるよりも、逆転させた方が簡単になる}ということに気付けなかった。
この歴史的挿話は、学ぶことが多いように感じられるが、改めて注意を添えるならば、楕円\kenten{積分}と楕円\kenten{関数}、楕円\kenten{曲線}はいずれも別物である。
2種類の形で紹介したが、両者に差異はないことは、\IND{Tschirnhaus変換}{Tschirnhausへんかん}(Tschirnhaus transformation)を知っていれば分かる。
用途によって適宜使い分けるので、一方しか紹介しない教科書もあるが混乱しないようにしたい。

また、どんな体で考えるかも重要で、ここでは基本的に有限体$\mathbb{F}_q$を考えるが、複素数体$\mathbb{C}$や有理数体$\mathbb{Q}$が歴史的には先行するし、まったく別物と思えるほど駆使するテクニックは異なる。
何が言いたいかというと、ここで紹介する「楕円曲線」とは、本当の楕円曲線のほんの一面を垣間見ているに過ぎないということだ。

試しに、\kenten{一般的な}楕円曲線を定義してみよう。

\begin{Defi}{\IND{楕円曲線}{たえんきよくせん}, elliptic curve}{elliptic_curve}
体$K$上の楕円曲線$E$は、次の形の、任意の点において滑らかであるような方程式で与えられる曲線である。
\begin{align*}
y^2 + a_1xy + a_3y = x^3 + a_2x^2 + a_4x + a_6
\end{align*}
\end{Defi}

$K$の標数が2でないなら、$a_1 = a_3 = 0$としても一般性を失わない\Notes{なお、標数2における楕円曲線も興味深い研究対象である。}。
更に標数が3でもないなら、Tschirnhaus変換($x\to x-a_2/3$という変数変換)によって$x^2$項も削除できるが、既に述べたように用途によって使い分ける。
「滑らか」という条件は、標数が2でないなら右辺の3次式が重根を持たないことと同値である。
つまり、式(\ref{eq:elliptic_curve_1})においては、$4a^3+27b\neq0$であること、式(\ref{eq:elliptic_curve_2})においては、$4A^3+27B^2-18ABC-A^2C^2 + 4BC^3\neq0$であることが要請される。

例えば、$y^2=x^3-x$を考えてみよう。
$a=-1,b=0$の場合だ。
$4a^3+27b=-4\neq0$なので確かに条件を満たしている。
興味あるのは、この楕円曲線の解であるが、すぐさま$(x,y)=(0,0),(\pm1,0)$という解が思いつく。
他には存在するだろうか？

\begin{Prop}{}{y2_x3x}
$y^2=x^3-x$の有理数解は、
\begin{align*}
(x,y) = (0,0), (\pm1, 0)
\end{align*}
のみである。
\end{Prop}

Fermat自身は、\IND{Fermatの最終定理}{Fermatのさいしゆうていり}(Fermat's Last Theorem)を証明したと主張したが、今では多くの人が懐疑的である。
それでもFermatが確実に証明したとされているのが$n=4$の場合、つまり、\rProp{FLT_4}を証明したことは確かである。

\begin{Prop}{}{FLT_4}
$x^4+y^4=z^4$の自然数解は存在しない。
\end{Prop}

Fermatは、\rProp{right_triangle_area}を証明し、そこから\rProp{FLT_4}を導いたが、実は\rProp{right_triangle_area}を楕円曲線の言葉に言い換えたのが\rProp{y2_x3x}であって、両者は同じことを言っているのである。

\begin{Prop}{}{right_triangle_area}
3辺の長さが整数で面積が平方数である直角三角形は、存在しない。
\end{Prop}

このような楕円曲線がなぜ重要なのだろうか。
その重要性を語るには何万語かけても足りないが、ここで注目するのは群を成すという点である。
正確には、楕円曲線上の点に、無限遠点と呼ばれる点$O$を加えた点の集合は群を成す。
この群を、体$K$と楕円曲線$E$を使って$E(K)$と書こう。
つまり、楕円曲線上の任意の点$P,Q$には加法(足し算)が定義できるのだ。
この演算を要約すれば、「直線が、楕円曲線と交わる3点の和はゼロになる」ということになる。
ここでは深く考えずに、次のような計算によって「足し算っぽい」ことができるとボンヤリ分かれば十分だ。

$P=(x_P,y_P)$,$Q=(x_Q,y_Q)$とする。$P+Q$の座標$(x_{P+Q},y_{P+Q})$は、
$P\neq Q$のとき、
\begin{align*}
x_{P+Q} &= \alpha^2 - x_P - x_Q\\
y_{P+Q} &= -y_P + \alpha(x_P - x_{P+Q})
\end{align*}
ただし、
\begin{align*}
\alpha = \frac{y_Q - y_P}{x_Q - x_P}
\end{align*}
$P=Q$のとき、
\begin{align*}
x_{P+Q} &= \beta^2 - 2x_P\\
y_{P+Q} &= -y_P + \beta(x_P - x_{P+Q})
\end{align*}
ただし、
\begin{align*}
\beta = \frac{3y_P^2 + a}{2y_P}
\end{align*}

また、複数回の加法を次のように書くこととする。
\begin{align*}
[m]P = \underbrace{P+P+\cdots+P }_{m\text{ times}}
\end{align*}
単に$mP$と書かれることもあるが、整数と楕円曲線上の点とを区別するために、ここではあえてこのように書く。

再度、$E:y^2=x^3-x$にご登場いただこう。
\rProp{y2_x3x}によれば、有理数点は3つだから、
\begin{align*}
E(\mathbb{Q}) = \{O, (0,0), (\pm1,0)\}
\end{align*}
という群を成す。
しかも、すべての元で$[2]P=O$を満たすから
\begin{align*}
E(\mathbb{Q}) \cong \mathbb{Z}_2 \times \mathbb{Z}_2
\end{align*}
という群である。

有理数体$\mathbb{Q}$上の楕円曲線$E(\mathbb{Q})$がどのような群になるかということに関して、\IND{Mordellの定理}{Mordellのていり}(Mordell's theorem)が有名であるが、有限体$\mathbb{F}_q$上の楕円曲線$E(\mathbb{Q}_q)$においても類似の結果が知られている。

\begin{Theo}{\cite{Cassels1966DiophantineEW}}{cassels}
有限体$\mathbb{F}_q$上の楕円曲線$E(\mathbb{F}_q)$は、次のいずれかと同型である。
\begin{itemize}
 \item 巡回群
 \item 2つの巡回群の直積$\mathbb{Z}_{d_1}\times\mathbb{Z}_{d_2}$
\end{itemize}
ここで、$d_1 \mid d_2$ かつ $d_1 \mid q - 1$ である。
\end{Theo}

\rTheo{cassels}から例えば、群$E(\mathbb{F}_7)$は巡回群になる以外に、
\begin{itemize}
 \item $\mathbb{Z}_2 \times \mathbb{Z}_2, \mathbb{Z}_2 \times \mathbb{Z}_4, \mathbb{Z}_2 \times \mathbb{Z}_6,\ldots$
 \item $\mathbb{Z}_3 \times \mathbb{Z}_3, \mathbb{Z}_3 \times \mathbb{Z}_6, \mathbb{Z}_3 \times \mathbb{Z}_9,\ldots$
\end{itemize}
となる可能性があることが分かる(実際は\rTheo{Hasse's_theorem}によって更に限定される)。

$E(\mathbb{F}_p)$の具体的な元を枚挙することは、一般には困難だが、位数が小さければ比較的簡単だ。
まず、無限遠点$O$は必ず存在する。
$x\in F$を$x^3+ax+b$に代入してみて、平方非剰余なら対応する$y$は存在しないし、平方剰余なら$(x,\pm\sqrt{x^3+ax+b})$の2点が元である。
$x^3+ax+b \equiv 0 \pmod{n}$なら、$(x,0)$の1点が元である。
よって、群の位数は次のように\kenten{正確}に求められる。
なお、カッコはLegendre記号(\rDefi{Legendre_symbol})である。
\begin{align*}
\sharp E(\mathbb{F}_p) = p + 1 + \sum_{x \in \mathbb{F}_p} \left( \frac{x^3+ax+b}{p} \right)
\end{align*}

\Algo{楕円曲線上の点を枚挙する}{elliptic_curve_points}{c.f., \rAlgo{legendre_symbol}, \rAlgo{square_root}}

\Algo{楕円曲線の位数}{elliptic_curve_order}{c.f., \rAlgo{legendre_symbol}}

$p$が小さいうちは簡単に求められるが、$p$が大きくなると途端に手に負えなくなる。
そこで\rTheo{Hasse's_theorem}は、位数が取り得る値を教えてくれる。

\begin{Theo}{\IND{Hasseの定理}{Hasseのていり}, Hasse's theorem}{Hasse's_theorem}
群$E(\mathbb{F}_{p^k})$の位数$\sharp E(\mathbb{F}_{p^k})$は次を満たす。
\begin{align*}
|\sharp E(\mathbb{F}_{p^k}) - (p^k + 1)| \le 2\sqrt{p^k}
\end{align*}
\end{Theo}

特に$k=1$のとき、つまり、$E(\mathbb{F}_{p})$の位数は、
\begin{align*}
p+1-2\sqrt{p} < \sharp E(\mathbb{F}_{p}) < p+1+2\sqrt{p}
\end{align*}
である。

群$E(\mathbb{F}_7)$に当てはめてみると
\begin{align*}
2.71\ldots < \sharp E(\mathbb{F}_7) < 13.29\ldots
\end{align*}
が得られ、位数が取り得るのは3から13であることが分かる。
ということは、位数16となる$\mathbb{Z}_2 \times \mathbb{Z}_8$や、位数18となる$\mathbb{Z}_3 \times \mathbb{Z}_6$とはならないことが分かる。
改めて整理すれば、群$E(\mathbb{F}_7)$が取り得る構造というのは、次に限られる。
\begin{itemize}
 \item $\mathbb{Z}_n$ ただし、$3 \le n \le 13$
 \item $\mathbb{Z}_2 \times \mathbb{Z}_2, \mathbb{Z}_2 \times \mathbb{Z}_4, \mathbb{Z}_2 \times \mathbb{Z}_6, \mathbb{Z}_3 \times \mathbb{Z}_3$
\end{itemize}

では、どの楕円曲線のときどの群となるのか？　一般には難しい問題であるが、$E(\mathbb{F}_7)$は高々$7^2$パターンしかないので調べるのは容易い(表\ref{table:EFF_7}\Notes{$(a,b)=(0,0),(1,2),(1,5),(2,2),(2,5),(4,2),(4,5)$は楕円曲線の条件を満たさない。})。

\begin{table}[htb]\label{table:EFF_7}
\begin{center}
\caption{$E(\mathbb{F}_7)$の楕円曲線のパラメータ$(a,b)$の違いによる群構造の変化}
\begin{tabular}{|l|l|l|}\hline
位数 & $\mathbb{Z}_n$                         & $\mathbb{Z}_{d_1}\times\mathbb{Z}_{d_2}$ \\\hline\hline
3  & (0,4)                                    &                                          \\\hline
4  & (3,6), (5,6), (6,6)                      & (0,6)                                    \\\hline
5  & (1,1), (2,1), (4,1)                      &                                          \\\hline
6  & (1,3), (2,3), (3,3), (4,3), (5,3), (6,3) &                                          \\\hline
7  & (0,5), (3,5). (5,5), (6,5)               &                                          \\\hline
8  & (1,0), (2,0), (4,0)                      & (3,0), (5,0), (6,0)                      \\\hline
9  & (3,2), (5,2), (6,2)                      & (0,2)                                    \\\hline
10 & (1,4), (2,4), (3,4), (4,4), (5,4), (6,4) &                                          \\\hline
11 & (1,6), (2,6), (4,6)                      &                                          \\\hline
12 & (3,1), (5,1), (6,1)                      & (0,1)                                    \\\hline
13 & (0,3)                                    &                                          \\\hline
\end{tabular}
\end{center}
\end{table}

数学上の様態は理解が進んだかと思うが、これをプログラムに落とし込もうと思うと無限遠点$O$をどう扱うかなど、考える要素はいくつもある。
ここで紹介する実装方法は4種類である。
\begin{description}
 \item [アフィン座標]\mbox{}\\
       $(x,y,z)$の3つ組で管理し、楕円曲線上の点$(x,y)$は$(x,y,1)$、無限遠点は$(0,\pm1,0)$とする。
 \item [射影座標]\mbox{}\\
       $(X,Y,Z)$の3つ組で管理し、無限遠点は$(0,1,0)$とする。
       無限遠点でない射影座標$(X,Y,Z)$は、アフィン座標$(X/Z,Y/Z,1)$に対応する。
 \item [修正射影座標]\mbox{}\\
       $(X,Y,Z)$の3つ組で管理し、無限遠点は$(0,1,0)$とする。
       無限遠点でない修正射影座標$(X,Y,Z)$は、アフィン座標$(X/Z^2,Y/Z^3,1)$に対応する。
 \item [Montgomery座標]\mbox{}\\
       $(X,Z)$の2つ組で管理し、無限遠点は$(0,0)$とする。
       無限遠点でないMontogomery座標$(X,Z)$は、アフィン座標$(X/Z,?,1)$に対応する。
\end{description}
アフィン座標は、上記数式の素朴な実装だ。
それに対して射影座標、修正射影座標は、逆元計算をなるべくしないようにしたいという意図がある。
Montgomery座標は、そもそも$y$座標を管理しない。
$y$座標に興味がない場合に使えて、素因数分解の高速化の際に触れる。

まずは、アフィン座標での実装例を見てみよう。

\Algo{アフィン座標による楕円曲線の実装}{EllipticCurveAffine}{c.f., \rAlgo{inverse_mod}, \rAlgo{n_times}}

実装でネタバレをしているのだが、この楕円曲線に与える$p$は\textbf{素数でなくともよい}。
もちろん、$p$が素数でなければ群にはならないのだが、大抵の点で計算は問題なく行える。
計算が失敗し、群でないことが露わになる瞬間、うれしいことに一緒に素因数まで判明する。
素因数分解をしたい我々にとって願ってもない結果だ。
というわけで、これを素因数分解に使わない手はない。

\Algo{楕円曲線法}{elliptic_curve_method}{c.f., \rAlgo{EllipticCurveAffine}}

楕円曲線法は、$p-1$法(\rAlgo{p_minus_1_method})に類似していることに気付いただろうか？　$p-1$法は$p-1$が$B$-smoothであるとき、素因数分解に成功したが、楕円曲線法も同じようなことが言える。
$p-1$法がなぜ$p-1$であったかと言えば、それが群の位数だったからである。
同様に、楕円曲線法も群の位数が$B$-smoothであれば素因数分解できる。
既に見たように、楕円曲線の群の位数はパラメータによって変化する。
つまり、楕円曲線のパラメータを動かすことによって、\kenten{たまたま}smoothな位数に巡り合えることができればよい。
また、楕円曲線を決めてから点を選ぼうとすると考えることが多くなるが、点を決めてからそれに合うように楕円曲線を選んでもよいので、そういう疑問も解決する。

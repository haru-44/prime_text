<html lang="ja">
  <head>
    <title>elliptic_curve_def</title>
    <script type="text/x-mathjax-config">
       MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}});
    </script>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML,/www_func/MathJax/MyConfig.js">
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=py&skin=sunburst"></script>
  </head>
  <body>
  <strong>このページは、pdfファイル出力用に作成したtexファイルから機械的に変換されています。体裁不良がある場合は<a href="https://github.com/haru-44/prime_text/releases/latest/download/main.pdf">pdfファイル</a>をご覧ください。</strong>
  <hr/>
<h1>elliptic_curve_def</h1>
<p><h2>定義</h2>
まず、「楕円曲線」とは、
\begin{align}
\label{eq:elliptic_curve_1}
y^2 = x^3 + ax + b
\end{align}
と書ける方程式、あるいは同じことであるが、
\begin{align}
\label{eq:elliptic_curve_2}
y^2 = x^3 + Cx^2 + Ax + B
\end{align}
と書ける方程式のことである。
厳密には、「標数が2でも3でもないとき」などの前置きが必要になるが、ここでは一旦忘れる。
\(a,b\)や\(A,B,C\)の値によって曲線の形は様々に変わり得るが、多くの類書が注意するようにこの形が楕円であるわけではない。
古くは、楕円の弧長を求める際に必要となる<strong>楕円積分</strong>(elliptic integral)に端を発し、Niels Abelによって、楕円積分の逆関数として<strong>楕円関数</strong>(elliptic function)が発見されたという歴史がある故である。
楕円積分は、高校で習う程度の積分テクニックでは太刀打ちできない難物で、Legendreは、Legendre記号()などに名を残す偉大な数学者であるが、彼の生涯の大部分を費やしても<strong>楕円積分そのものを考えるよりも、逆転させた方が簡単になる</strong>ということに気付けなかった。
この歴史的挿話は、学ぶことが多いように感じられるが、改めて注意を添えるならば、楕円<strong>積分</strong>と楕円<strong>関数</strong>、楕円<strong>曲線</strong>はいずれも別物である。
2種類の形で紹介したが、両者に差異はないことは、<strong>Tschirnhaus変換</strong>(Tschirnhaus transformation)を知っていれば分かる。
用途によって適宜使い分けるので、一方しか紹介しない教科書もあるが混乱しないようにしたい。
</p>
<p>また、どんな体で考えるかも重要で、ここでは基本的に有限体\(\mathbb{F}_q\)を考えるが、複素数体\(\mathbb{C}\)や有理数体\(\mathbb{Q}\)が歴史的には先行するし、まったく別物と思えるほど駆使するテクニックは異なる。
何が言いたいかというと、ここで紹介する「楕円曲線」とは、本当の楕円曲線のほんの一面を垣間見ているに過ぎないということだ。
</p>
<p>試しに、<strong>一般的な</strong>楕円曲線を定義してみよう。
</p>
<div style="padding: 10px; margin-bottom: 10px; border: 1px solid #000000;">(<strong>定義</strong>)
体\(K\)上の楕円曲線\(E\)は、次の形の、任意の点において滑らかであるような方程式で与えられる曲線である。
\begin{align*}
y^2 + a_1xy + a_3y = x^3 + a_2x^2 + a_4x + a_6
\end{align*}
</div>

<p>\(K\)の標数が2でないなら、\(a_1 = a_3 = 0\)としても一般性を失わない{なお、標数2における楕円曲線も興味深い研究対象である。}。
更に標数が3でもないなら、Tschirnhaus変換(\(x\to x-a_2/3\)という変数変換)によって\(x^2\)項も削除できるが、既に述べたように用途によって使い分ける。
「滑らか」という条件は、標数が2でないなら右辺の3次式が重根を持たないことと同値である。
つまり、式(\ref{eq:elliptic_curve_1})においては、\(4a^3+27b\neq0\)であること、式(\ref{eq:elliptic_curve_2})においては、\(4A^3+27B^2-18ABC-A^2C^2 + 4BC^3\neq0\)であることが要請される。
</p>
<p>例えば、\(y^2=x^3-x\)を考えてみよう。
\(a=-1,b=0\)の場合だ。
\(4a^3+27b=-4\neq0\)なので確かに条件を満たしている。
興味あるのは、この楕円曲線の解であるが、すぐさま\((x,y)=(0,0),(\pm1,0)\)という解が思いつく。
他には存在するだろうか？
</p>
<div style="padding: 10px; margin-bottom: 10px; border: 1px solid #000000;">(<strong>命題</strong>)
\(y^2=x^3-x\)の有理数解は、
\begin{align*}
(x,y) = (0,0), (\pm1, 0)
\end{align*}
のみである。
</div>

<p>Fermat自身は、<strong>Fermatの最終定理</strong>(Fermat's Last Theorem)を証明したと主張したが、今では多くの人が懐疑的である。
それでもFermatが確実に証明したとされているのが\(n=4\)の場合、つまり、を証明したことは確かである。
</p>
<div style="padding: 10px; margin-bottom: 10px; border: 1px solid #000000;">(<strong>命題</strong>)
\(x^4+y^4=z^4\)の自然数解は存在しない。
</div>

<p>Fermatは、を証明し、そこからを導いたが、実はを楕円曲線の言葉に言い換えたのがであって、両者は同じことを言っているのである。
</p>
<div style="padding: 10px; margin-bottom: 10px; border: 1px solid #000000;">(<strong>命題</strong>)
3辺の長さが整数で面積が平方数である直角三角形は、存在しない。
</div>

<p>このような楕円曲線がなぜ重要なのだろうか。
その重要性を語るには何万語かけても足りないが、ここで注目するのは群を成すという点である。
正確には、楕円曲線上の点に、無限遠点と呼ばれる点\(O\)を加えた点の集合は群を成す。
この群を、体\(K\)と楕円曲線\(E\)を使って\(E(K)\)と書こう。
つまり、楕円曲線上の任意の点\(P,Q\)には加法(足し算)が定義できるのだ。
この演算を要約すれば、「直線が、楕円曲線と交わる3点の和はゼロになる」ということになる。
ここでは深く考えずに、次のような計算によって「足し算っぽい」ことができるとボンヤリ分かれば十分だ。
</p>
<p>\(P=(x_P,y_P)\),\(Q=(x_Q,y_Q)\)とする。\(P+Q\)の座標\((x_{P+Q},y_{P+Q})\)は、
\(P\neq Q\)のとき、
\begin{align*}
x_{P+Q} &= \alpha^2 - x_P - x_Q\\
y_{P+Q} &= -y_P + \alpha(x_P - x_{P+Q})
\end{align*}
ただし、
\begin{align*}
\alpha = \frac{y_Q - y_P}{x_Q - x_P}
\end{align*}
\(P=Q\)のとき、
\begin{align*}
x_{P+Q} &= \beta^2 - 2x_P\\
y_{P+Q} &= -y_P + \beta(x_P - x_{P+Q})
\end{align*}
ただし、
\begin{align*}
\beta = \frac{3y_P^2 + a}{2y_P}
\end{align*}
</p>
<p>また、複数回の加法を次のように書くこととする。
\begin{align*}
[m]P = \underbrace{P+P+\cdots+P }_{m\text{ times}}
\end{align*}
単に\(mP\)と書かれることもあるが、整数と楕円曲線上の点とを区別するために、ここではあえてこのように書く。
</p>
<p>再度、\(E:y^2=x^3-x\)にご登場いただこう。
によれば、有理数点は3つだから、
\begin{align*}
E(\mathbb{Q}) = \{O, (0,0), (\pm1,0)\}
\end{align*}
という群を成す。
しかも、すべての元で\([2]P=O\)を満たすから
\begin{align*}
E(\mathbb{Q}) \cong \mathbb{Z}_2 \times \mathbb{Z}_2
\end{align*}
という群である。
</p>
<p><h2>群の構造</h2>
有理数体\(\mathbb{Q}\)上の楕円曲線\(E(\mathbb{Q})\)がどのような群になるかということに関して、<strong>Mordellの定理</strong>(Mordell's theorem)が有名であるが、有限体\(\mathbb{F}_q\)上の楕円曲線\(E(\mathbb{F}_q)\)においても類似の結果が知られている。
</p>
<div style="padding: 10px; margin-bottom: 10px; border: 1px solid #000000;">(<strong>定理</strong>)
有限体\(\mathbb{F}_q\)上の楕円曲線\(E(\mathbb{F}_q)\)は、次のいずれかと同型である。
<ul>
 <li> 巡回群
 <li> 2つの巡回群の直積\(\mathbb{Z}_{d_1}\times\mathbb{Z}_{d_2}\)
</ul>
ここで、\(d_1 \mid d_2\) かつ \(d_1 \mid q - 1\) である。
</div>

<p>から例えば、群\(E(\mathbb{F}_7)\)は巡回群になる以外に、
</p><ul>
 <li> \(\mathbb{Z}_2 \times \mathbb{Z}_2, \mathbb{Z}_2 \times \mathbb{Z}_4, \mathbb{Z}_2 \times \mathbb{Z}_6,\ldots\)
 <li> \(\mathbb{Z}_3 \times \mathbb{Z}_3, \mathbb{Z}_3 \times \mathbb{Z}_6, \mathbb{Z}_3 \times \mathbb{Z}_9,\ldots\)
</ul>
<p>となる可能性があることが分かる(実際はによって更に限定される)。
</p>
<p>\(E(\mathbb{F}_p)\)の具体的な元を枚挙することは、一般には困難だが、位数が小さければ比較的簡単だ。
まず、無限遠点\(O\)は必ず存在する。
\(x\in F\)を\(x^3+ax+b\)に代入してみて、平方非剰余なら対応する\(y\)は存在しないし、平方剰余なら\((x,\pm\sqrt{x^3+ax+b})\)の2点が元である。
\(x^3+ax+b \equiv 0 \pmod{n}\)なら、\((x,0)\)の1点が元である。
よって、群の位数は次のように<strong>正確</strong>に求められる。
なお、カッコはLegendre記号()である。
\begin{align*}
\sharp E(\mathbb{F}_p) = p + 1 + \sum_{x \in \mathbb{F}_p} \left( \frac{x^3+ax+b}{p} \right)
\end{align*}
</p>
<pre class="prettyprint">from typing import Generator, Tuple

from legendre_symbol import legendre_symbol
from tonelli_shanks_algorithm import tonelli_shanks_algorithm


def elliptic_curve_points(a: int, b: int, p: int) -> Generator[Tuple[int, int], None, None]:
    """ 楕円曲線 y**2 = x**3 + a*x + b (mod p) の点を枚挙する。

    Args:
        a: int, b: int: 楕円曲線のパラメータ。y**2 = x**3 + a * x + b
        p (int): p > 3となる素数。

    Yields:
        x, y (int, int): 楕円曲線上の点(無限遠点を除く)

    Examples:
        >>> list(elliptic_curve_points(1, 3, 5))
        [(1, 0), (4, 1), (4, 4)]
        >>> list(elliptic_curve_points(1, 1, 5))
        [(0, 1), (0, 4), (2, 1), (2, 4), (3, 1), (3, 4), (4, 2), (4, 3)]
    """
    assert (4 * a**3 + 27 * b**2) % p != 0
    for x in range(p):
        y2 = (x**3 + a*x + b) % p
        legendre = legendre_symbol(y2, p)
        if legendre == 0:
            yield x, 0
        elif legendre == 1:
            y = tonelli_shanks_algorithm(y2, p)
            yield x, y
            yield x, -y % p
</pre>

<pre class="prettyprint">from legendre_symbol import legendre_symbol


def elliptic_curve_order_naive(a: int, b: int, p: int) -> int:
    """ 楕円曲線 y**2 = x**3 + a*x + b (mod p) の群の位数を計算する。

    Args:
        a: int, b: int: 楕円曲線のパラメータ。y**2 = x**3 + a * x + b
        p (int): p > 3となる素数。

    Return:
        int: 群の位数

    Examples:
        >>> elliptic_curve_order_naive(1, 3, 5)
        4
        >>> elliptic_curve_order_naive(1, 1, 5)
        9
    """
    assert (4 * a**3 + 27 * b**2) % p != 0
    return p + 1 + sum(legendre_symbol(x**3 + a * x + b, p) for x in range(p))
</pre>

<p>\(p\)が小さいうちは簡単に求められるが、\(p\)が大きくなると途端に手に負えなくなる。
そこでは、位数が取り得る値を教えてくれる。
</p>
<div style="padding: 10px; margin-bottom: 10px; border: 1px solid #000000;">(<strong>定理</strong>)
群\(E(\mathbb{F}_{p^k})\)の位数\(\sharp E(\mathbb{F}_{p^k})\)は次を満たす。
\begin{align*}
|\sharp E(\mathbb{F}_{p^k}) - (p^k + 1)| \le 2\sqrt{p^k}
\end{align*}
</div>

<p>特に\(k=1\)のとき、つまり、\(E(\mathbb{F}_{p})\)の位数は、
\begin{align*}
p+1-2\sqrt{p} < \sharp E(\mathbb{F}_{p}) < p+1+2\sqrt{p}
\end{align*}
である。
</p>
<p>群\(E(\mathbb{F}_7)\)に当てはめてみると
\begin{align*}
2.71\ldots < \sharp E(\mathbb{F}_7) < 13.29\ldots
\end{align*}
が得られ、位数が取り得るのは3から13であることが分かる。
ということは、位数16となる\(\mathbb{Z}_2 \times \mathbb{Z}_8\)や、位数18となる\(\mathbb{Z}_3 \times \mathbb{Z}_6\)とはならないことが分かる。
改めて整理すれば、群\(E(\mathbb{F}_7)\)が取り得る構造というのは、次に限られる。
</p><ul>
 <li> \(\mathbb{Z}_n\) ただし、\(3 \le n \le 13\)
 <li> \(\mathbb{Z}_2 \times \mathbb{Z}_2, \mathbb{Z}_2 \times \mathbb{Z}_4, \mathbb{Z}_2 \times \mathbb{Z}_6, \mathbb{Z}_3 \times \mathbb{Z}_3\)
</ul>

<p>では、どの楕円曲線のときどの群となるのか？　一般には難しい問題であるが、\(E(\mathbb{F}_7)\)は高々\(7^2\)パターンしかないので調べるのは容易い(表\ref{table:EFF_7}{\((a,b)=(0,0),(1,2),(1,5),(2,2),(2,5),(4,2),(4,5)\)は楕円曲線の条件を満たさない。})。
</p>
<p>\begin{table}[htb]\label{table:EFF_7}
\begin{center}
\caption{\(E(\mathbb{F}_7)\)の楕円曲線のパラメータ\((a,b)\)の違いによる群構造の変化}
\begin{tabular}{|l|l|l|}\hline
位数 & \(\mathbb{Z}_n\)                         & \(\mathbb{Z}_{d_1}\times\mathbb{Z}_{d_2}\) \\\hline\hline
3  & (0,4)                                    &                                          \\\hline
4  & (3,6), (5,6), (6,6)                      & (0,6)                                    \\\hline
5  & (1,1), (2,1), (4,1)                      &                                          \\\hline
6  & (1,3), (2,3), (3,3), (4,3), (5,3), (6,3) &                                          \\\hline
7  & (0,5), (3,5), (5,5), (6,5)               &                                          \\\hline
8  & (1,0), (2,0), (4,0)                      & (3,0), (5,0), (6,0)                      \\\hline
9  & (3,2), (5,2), (6,2)                      & (0,2)                                    \\\hline
10 & (1,4), (2,4), (3,4), (4,4), (5,4), (6,4) &                                          \\\hline
11 & (1,6), (2,6), (4,6)                      &                                          \\\hline
12 & (3,1), (5,1), (6,1)                      & (0,1)                                    \\\hline
13 & (0,3)                                    &                                          \\\hline
\end{tabular}
\end{center}
\end{table}
</p>

</body></html>